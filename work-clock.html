<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê·¼ë¬´ì‹œê°„ ê³„ì‚°ê¸° - ìë™ ì´ë™</title>
    <style>
        body {
            font-family: -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 15px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        .install-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 50px;
            border-radius: 15px;
            text-align: center;
            margin: 40px 0;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        .install-box p {
            color: white;
            margin-bottom: 25px;
            font-size: 1.3em;
            font-weight: 500;
        }
        .bookmarklet {
            display: inline-block;
            padding: 20px 45px;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.4em;
            cursor: move;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        .bookmarklet:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }
        .feature {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #667eea;
        }
        .feature h3 {
            color: #667eea;
            margin-top: 0;
        }
        .highlight {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 3px solid #4CAF50;
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
        }
        .highlight h3 {
            color: #2e7d32;
            margin-top: 0;
        }
        code {
            background: #ffe082;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Monaco', monospace;
            color: #d84315;
        }
        ul {
            line-height: 2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ•’ğŸ’»ğŸ˜µâ€ğŸ’«</h1>
        <p class="subtitle">ì–´ë””ì„œë‚˜ í´ë¦­ í•œ ë²ˆìœ¼ë¡œ ìë™ ì´ë™ & ê³„ì‚°</p>

        <div class="install-box">
            <p>ğŸ‘‡ ì´ ë²„íŠ¼ì„ ë¶ë§ˆí¬ë°”ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
            <a id="bookmarklet" href="#" class="bookmarklet">ğŸ•’ ê·¼ë¬´ì‹œê°„ ê³„ì‚°ê¸°</a>
        </div>

        <div class="highlight">
            <h3>ğŸ” empId ì°¾ëŠ” ë°©ë²•</h3>
            <p><strong>ê°œë°œì ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ empIdë¥¼ í™•ì¸í•˜ì„¸ìš”:</strong></p>
            <ol style="font-size: 1em; line-height: 1.8;">
                <li><strong>F12</strong> í‚¤ë¥¼ ëˆŒëŸ¬ ê°œë°œì ë„êµ¬ ì—´ê¸°</li>
                <li><strong>Network</strong> íƒ­ ì„ íƒ</li>
                <li>'ê·¼ë¡œ ì‹œê°„ í˜„í™©' í˜ì´ì§€ì—ì„œ <strong>'ê²€ìƒ‰'</strong> ë²„íŠ¼ í´ë¦­</li>
                <li>ë²„íŠ¼ í´ë¦­ ì‹œ <strong>"list?"</strong> ë¡œ ì‹œì‘í•˜ëŠ” API ìš”ì²­ ì°¾ì•„ì„œ í´ë¦­</li>
                <li><strong>Payload</strong> íƒ­ì—ì„œ <strong>empId</strong> ê°’ ë³µì‚¬</li>
            </ol>
            <p style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 0.95em;">
                ğŸ’¡ <strong>ì°¸ê³ </strong> empIdëŠ” í•œ ë²ˆë§Œ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤!
            </p>
        </div>

        <div class="feature">
            <h3>ğŸš€ ì‚¬ìš© ë°©ë²•</h3>
            <ol style="line-height: 2;">
                <li>ìœ„ì˜ ë²„íŠ¼ì„ ë¶ë§ˆí¬ë°”ë¡œ ë“œë˜ê·¸</li>
                <li><strong>ì–´ëŠ ì›¹í˜ì´ì§€ì—ì„œë“ </strong> ë¶ë§ˆí¬ í´ë¦­ (1ì°¨ í´ë¦­)</li>
                <li>'ê·¼ë¡œ ì‹œê°„ í˜„í™©' í˜ì´ì§€ê°€ ì•„ë‹ˆë©´ <strong>ìë™ìœ¼ë¡œ ë°”ë¡œ ì´ë™</strong></li>
                <li>í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ë¶ë§ˆí¬ë¥¼ <strong>í•œ ë²ˆ ë” í´ë¦­</strong> (2ì°¨ í´ë¦­)</li>
                <li>ê·¼ë¬´ ì‹œê°„ ê³„ì‚° ê²°ê³¼ í™•ì¸!</li>
            </ol>
            <p style="padding: 10px; background: #e3f2fd; border-left: 4px solid #2196F3; border-radius: 4px; font-size: 0.9em; margin-top: 15px;">
                ğŸ’¡ <strong>íŒ:</strong> Workplace í˜ì´ì§€ì—ì„œ ë°”ë¡œ ì‹¤í–‰í•˜ë©´ í•œ ë²ˆë§Œ í´ë¦­í•˜ë©´ ë©ë‹ˆë‹¤!
            </p>
            <p style="padding: 10px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px; font-size: 0.9em; margin-top: 10px;">
                âš ï¸ <strong>ì£¼ì˜:</strong> ë¹ˆ íƒ­(ìƒˆ íƒ­)ì—ì„œëŠ” ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìƒ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
                ğŸ‘‰ ì•„ë¬´ ì›¹ì‚¬ì´íŠ¸(ì˜ˆ: êµ¬ê¸€, ë„¤ì´ë²„ ë“±)ë¥¼ ë¨¼ì € ì—´ê³  ë¶ë§ˆí¬ë¥¼ í´ë¦­í•˜ì„¸ìš”.
            </p>
        </div>

        <div class="feature">
            <h3>ğŸ“Š ê³„ì‚°ë˜ëŠ” ì •ë³´</h3>
            <ul>
                <li><strong>ì´ ê·¼ë¬´ì¼</strong>: ì´ë²ˆ ë‹¬ ì „ì²´ ê·¼ë¬´ì¼ (dayTpCd == 'WORK')</li>
                <li><strong>ì˜¤ëŠ˜ê¹Œì§€ ê·¼ë¬´í•œ ì‹œê°„</strong>: ì‹¤ì œë¡œ ì¼í•œ ì‹œê°„</li>
                <li><strong>ì•ìœ¼ë¡œ ê·¼ë¬´í•´ì•¼ í•˜ëŠ” ì‹œê°„</strong>: ì´ ê·¼ë¬´ì¼ Ã— 8h - ê·¼ë¬´ ì‹œê°„</li>
                <li><strong>í˜„ì¬ ì´ˆê³¼/ë¶€ì¡±</strong>: ì˜¤ëŠ˜ ê¸°ì¤€ ì´ˆê³¼/ë¶€ì¡± ì‹œê°„</li>
                <li><strong>ì˜¤ëŠ˜ í¬í•¨ ì—¬ë¶€</strong>: ì˜¤ëŠ˜ ê·¼ë¬´ì‹œê°„ ìë™ ê°ì§€</li>
            </ul>
        </div>

        <div class="feature">
            <h3>empId ì¬ì„¤ì •</h3>
            <p>ê²°ê³¼ í™”ë©´ì—ì„œ <strong>"empId ì¬ì„¤ì •"</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ìƒˆë¡œìš´ empIdë¥¼ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <p style="color: #999; font-size: 0.9em;">ğŸ’¡ ì €ì¥ëœ empIdë¥¼ ë³€ê²½í•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©í•˜ì„¸ìš”!</p>
        </div>
    </div>

    <script>
        // ë¶ë§ˆí¬ë¦¿ ì½”ë“œ (ì½ê¸° ì‰½ê²Œ ì‘ì„± í›„ ì¸ì½”ë”©)
        const bookmarkletSource = `
(function() {
    const targetUrl = 'https://workplace.worksmobile.com/my-space/work-statistics';
    const isWorkplacePage = window.location.href.includes('workplace.worksmobile.com/my-space/work-statistics');

    // ìë™ ì‹¤í–‰ í”Œë˜ê·¸ í™•ì¸
    const autoRunFlag = sessionStorage.getItem('work_clock_autorun');
    const wasAutoRedirected = autoRunFlag === 'pending';

    // í˜ì´ì§€ í™•ì¸ ë° ì´ë™
    if (!isWorkplacePage) {
        // ìë™ ì‹¤í–‰ í”Œë˜ê·¸ ì„¤ì •
        sessionStorage.setItem('work_clock_autorun', 'pending');
        window.location.href = targetUrl;
        return;
    }

    // ìë™ ì‹¤í–‰ë˜ì—ˆìœ¼ë©´ í”Œë˜ê·¸ ì œê±°
    if (wasAutoRedirected) {
        sessionStorage.removeItem('work_clock_autorun');
        // í˜ì´ì§€ ë¡œë“œ ëŒ€ê¸° (DOMì´ ì¤€ë¹„ë  ë•Œê¹Œì§€)
        if (document.readyState === 'loading') {
            alert('â³ í˜ì´ì§€ê°€ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë¶ë§ˆí¬ë¥¼ ë‹¤ì‹œ í´ë¦­í•´ì£¼ì„¸ìš”.');
            return;
        }
    }

    // ë‚ ì§œ ê³„ì‚°
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const fromDate = year + month + '01';
    const lastDay = new Date(year, now.getMonth() + 1, 0).getDate();
    const toDate = year + month + String(lastDay).padStart(2, '0');

    // empId ê°€ì ¸ì˜¤ê¸°
    let empId = localStorage.getItem('work_clock_empId');

    if (!empId) {
        empId = prompt('ğŸ“ empIdë¥¼ ì…ë ¥í•˜ì„¸ìš”\\n\\nğŸ” empId ì°¾ëŠ” ë°©ë²•:\\n1. F12 ê°œë°œì ë„êµ¬ ì—´ê¸°\\n2. Network íƒ­ ì„ íƒ\\n3. ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­\\n4. list? APIì˜ Payload íƒ­ì—ì„œ empId ë³µì‚¬\\n\\nğŸ’¡ í•œ ë²ˆë§Œ ì…ë ¥í•˜ë©´ ìë™ ì €ì¥ë©ë‹ˆë‹¤!');
        if (!empId) {
            alert('âŒ empIdê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }
    }

    // empId ì €ì¥
    localStorage.setItem('work_clock_empId', empId);

    // API í˜¸ì¶œ
    const apiUrl = 'https://workplace.worksmobile.com/my-space/work-statistics/list?fromDate=' + fromDate +
                   '&toDate=' + toDate + '&empId=' + empId + '&chkWorkingDay=Y&_=' + Date.now();

    // ë¡œë”© UI
    const loadingDiv = document.createElement('div');
    loadingDiv.id = 'work-clock-loading';
    loadingDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:10000;font-family:sans-serif;min-width:350px';
    loadingDiv.innerHTML = '<div style="text-align:center">â³ ê·¼ë¬´ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
    document.body.appendChild(loadingDiv);

    fetch(apiUrl)
        .then(r => {
            if (!r.ok) throw new Error('HTTP error! status: ' + r.status);
            return r.json();
        })
        .then(data => {
            console.log('API Response:', data);

            if (!data.data || !data.data.list) {
                throw new Error('ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ í˜•ì‹ì…ë‹ˆë‹¤.');
            }

            let records = data.data.list;
            console.log('Sample record:', records.find(r => r.sumWorkTime && r.sumWorkTime !== '0000'));

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let workedMinutes = 0;
            let totalWorkDays = 0;
            let pastWorkDays = 0;
            let workedToday = false;
            let todayInProgress = false;

            records.forEach(record => {
                if (record.dayTpCd !== 'WORK') return;

                totalWorkDays++;

                const recordDate = new Date(
                    record.checkYmd.substring(0, 4),
                    parseInt(record.checkYmd.substring(4, 6)) - 1,
                    parseInt(record.checkYmd.substring(6, 8))
                );

                const isToday = recordDate.getTime() === today.getTime();
                const workTime = record.sumWorkTime;
                const hasWorkTime = workTime && workTime !== '0000';

                if (recordDate < today) {
                    // ê³¼ê±° ë‚ ì§œ
                    pastWorkDays++;

                    if (hasWorkTime) {
                        const hours = parseInt(workTime.substring(0, 2), 10);
                        const minutes = parseInt(workTime.substring(2, 4), 10);

                        if (!isNaN(hours) && !isNaN(minutes)) {
                            workedMinutes += hours * 60 + minutes;
                        }
                    }
                } else if (isToday) {
                    // ì˜¤ëŠ˜
                    if (hasWorkTime) {
                        // ì˜¤ëŠ˜ í‡´ê·¼ ì°ìŒ
                        pastWorkDays++;
                        workedToday = true;

                        const hours = parseInt(workTime.substring(0, 2), 10);
                        const minutes = parseInt(workTime.substring(2, 4), 10);

                        if (!isNaN(hours) && !isNaN(minutes)) {
                            workedMinutes += hours * 60 + minutes;
                        }
                    } else {
                        // ì˜¤ëŠ˜ í‡´ê·¼ ì•ˆì°ìŒ (ì§„í–‰ ì¤‘)
                        todayInProgress = true;
                    }
                }
            });

            const shouldHaveWorked = pastWorkDays * 8 * 60;
            const totalRequiredMinutes = totalWorkDays * 8 * 60;
            const shouldWorkMore = totalRequiredMinutes - workedMinutes;
            const differenceMinutes = workedMinutes - shouldHaveWorked;

            let todayStatus = 'ì˜¤ëŠ˜ ì œì™¸';
            if (workedToday) {
                todayStatus = 'ì˜¤ëŠ˜ í¬í•¨';
            } else if (todayInProgress) {
                todayStatus = 'ì˜¤ëŠ˜ ì§„í–‰ ì¤‘ (í‡´ê·¼ ë¯¸ì²´í¬)';
            }
            const remainingWorkDays = totalWorkDays - pastWorkDays;

            const workedHours = Math.floor(workedMinutes / 60);
            const workedMins = workedMinutes % 60;
            const shouldWorkMoreHours = Math.floor(shouldWorkMore / 60);
            const shouldWorkMoreMins = shouldWorkMore % 60;
            const diffHours = Math.floor(Math.abs(differenceMinutes) / 60);
            const diffMins = Math.abs(differenceMinutes) % 60;
            const isOverTime = differenceMinutes > 0;

            const differenceText = isOverTime
                ? '<span style="color: #4CAF50; font-weight: bold;">+' + diffHours + 'ì‹œê°„ ' + diffMins + 'ë¶„ ì´ˆê³¼ âœ¨</span>'
                : '<span style="color: #f44336; font-weight: bold;">' + diffHours + 'ì‹œê°„ ' + diffMins + 'ë¶„ ë¶€ì¡± âš ï¸</span>';

            // ê²°ê³¼ UI (empId ì¬ì„¤ì • ë²„íŠ¼ ì¶”ê°€)
            loadingDiv.innerHTML = \`
                <div style="min-width:350px">
                    <h2 style="margin:0 0 20px 0;color:#333;text-align:center;border-bottom:2px solid #4CAF50;padding-bottom:10px">
                        ğŸ•’ \${year}ë…„ \${month}ì›” ê·¼ë¬´ í˜„í™©
                    </h2>
                    <div style="line-height:2;color:#555">
                        <div style="background:#f5f5f5;padding:10px;border-radius:5px;margin-bottom:10px">
                            <div style="font-size:0.9em;color:#999;margin-bottom:5px">ğŸ“… ì´ ê·¼ë¬´ì¼</div>
                            <div style="font-size:1.2em"><strong>\${totalWorkDays}ì¼</strong> (ì§€ë‚œ \${pastWorkDays}ì¼ + ë‚¨ì€ \${remainingWorkDays}ì¼)</div>
                        </div>
                        <div style="background:#e3f2fd;padding:10px;border-radius:5px;margin-bottom:10px">
                            <div style="font-size:0.9em;color:#1976D2;margin-bottom:5px">âœ… ì˜¤ëŠ˜ê¹Œì§€ ê·¼ë¬´í•œ ì‹œê°„</div>
                            <div style="font-size:1.3em;color:#1976D2"><strong>\${workedHours}ì‹œê°„ \${workedMins}ë¶„</strong></div>
                        </div>
                        <div style="background:#fff3e0;padding:10px;border-radius:5px;margin-bottom:10px">
                            <div style="font-size:0.9em;color:#e65100;margin-bottom:5px">ğŸ“‹ ì•ìœ¼ë¡œ ê·¼ë¬´í•´ì•¼ í•˜ëŠ” ì‹œê°„</div>
                            <div style="font-size:1.3em;color:#e65100"><strong>\${shouldWorkMoreHours}ì‹œê°„ \${shouldWorkMoreMins}ë¶„</strong></div>
                            <div style="font-size:0.85em;color:#999;margin-top:5px">
                                ì´ \${totalWorkDays}ì¼ Ã— 8h - ê·¼ë¬´ \${workedHours}h \${workedMins}m<br>
                                ğŸ’¡ \${todayStatus}
                            </div>
                        </div>
                        <div style="background:\${isOverTime ? '#e8f5e9' : '#ffebee'};padding:15px;border-radius:5px;border:2px solid \${isOverTime ? '#4CAF50' : '#f44336'}">
                            <div style="font-size:0.9em;color:#666;margin-bottom:5px">âš–ï¸ í˜„ì¬ ì´ˆê³¼/ë¶€ì¡±</div>
                            <div style="font-size:1.4em">\${differenceText}</div>
                            <div style="font-size:0.85em;color:#999;margin-top:5px">
                                ê·¼ë¬´ \${workedHours}h \${workedMins}m - í•„ìš” \${Math.floor(shouldHaveWorked/60)}h \${shouldHaveWorked%60}m
                            </div>
                        </div>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:20px">
                        <button id="work-clock-reset-empid" style="flex:1;padding:12px;background:#ff9800;color:white;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:bold">
                            empId ì¬ì„¤ì •
                        </button>
                        <button id="work-clock-close" style="flex:2;padding:12px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:bold">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            \`;

            document.getElementById('work-clock-close').addEventListener('click', () => {
                document.body.removeChild(loadingDiv);
            });

            document.getElementById('work-clock-reset-empid').addEventListener('click', () => {
                localStorage.removeItem('work_clock_empId');
                document.body.removeChild(loadingDiv);
                alert('âœ… empIdê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\\në¶ë§ˆí¬ë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ì—¬ ìƒˆë¡œìš´ empIdë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            });
        })
        .catch(err => {
            console.error('Error:', err);
            loadingDiv.innerHTML = \`
                <div style="color:red">
                    <h3>âŒ ì˜¤ë¥˜ ë°œìƒ</h3>
                    <p>\${err.message}</p>
                    <p style="font-size:0.9em;color:#666">ê°œë°œì ì½˜ì†”(F12)ì„ í™•ì¸í•˜ì„¸ìš”.</p>
                    <button onclick="this.parentElement.parentElement.remove()" style="margin-top:10px;padding:10px 20px;background:#f44336;color:white;border:none;border-radius:5px;cursor:pointer">
                        ë‹«ê¸°
                    </button>
                </div>
            \`;
        });
})();
        `;

        // URL ì¸ì½”ë”©í•˜ì—¬ ë¶ë§ˆí¬ë¦¿ ìƒì„±
        const bookmarkletCode = 'javascript:' + encodeURIComponent(bookmarkletSource.trim());
        const bookmarkletElement = document.getElementById('bookmarklet');
        bookmarkletElement.href = bookmarkletCode;

        // í´ë¦­ ì‹œ ì§ì ‘ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)
        bookmarkletElement.addEventListener('click', function(e) {
            e.preventDefault();
            eval(bookmarkletSource);
        });
    </script>
</body>
</html>
